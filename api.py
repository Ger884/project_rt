from flask import Flask, jsonify, request
from datetime import datetime, timedelta
from flask_cors import CORS
import random

app = Flask(__name__)
CORS(app)

HARVEST_DAYS = {
    "อัญชัน": 90,
    "มะกรูด": 150,
    "ตะไคร้": 90,
    "กระเทียม": 150,
    "มะเขือเปราะ": 90,
    "ฟักข้าว": 120,
    "มะเขือเทศ": 110,
    "ฟักทอง": 100,
    "แครอท": 90,
    "มะละกอ": 150,
    "มะรุม": 120,
    "บีทรูท": 90,
    "มะระขี้นก": 100,
    "กะเพรา": 60,
    "โหระพา": 60,
    "กระเจี๊ยบเขียว": 80,
    "ตำลึง": 70,
    "สะตอ": 100,
    "แตงกวา": 70,
    "ผักบุ้ง": 60,
    "ก กกช้าง ธูปฤาษี": 70,
    "ก้นจ้ำ": 90,
    "กรดน้ำ": 90,
    "กระเจี๊ยบเขียว": 80,
    "กระเจี๊ยบแดง": 80,
    "กระเจียวขาว": 85,
    "กระเจียวแดง": 85,
    "กระชับ หญ้าผมยุ่ง": 60,
    "กระชาย กระชายเหลือง": 90,
    "กระเช้าผีมด": 90,
    "กระดอม": 100,
    "กระดูกไก่ หอมไก๋": 90,
    "กระโดน กระโดนบก": 90,
    "กระถิน กระถินไทย กระถินบ้าน": 120,
    "กระทงลาย": 100,
    "กระทือ กะทือ": 90,
    "กระทุงหมาบ้า ผักฮ้วนหมู": 90,
    "กระเทียม": 150,
    "กระบก": 90,
    "กระพังโหม": 90,
    "กระวาน กระวานไทย": 90,
    "กระสัง": 90,
    "กรุงเขมา เครือหมาน้อย": 90,
    "กล้วยนวล": 180,
    "กลึงกล่อม น้ำนอง": 90,
    "กอกกั๋น อ้อยช้าง": 150,
    "กะตังใบ": 90,
    "กะทกรก": 90,
    "กะทือพิลาส": 90,
    "กะเพรา": 60,
    "กะเพราควาย ยี่หร่า": 60,
    "กะหนานปลิง": 90,
    "กะหล่ำดอก": 90,
    "กะหล่ำปลี": 90,
    "กัญชง เฮมพ์": 120,
    "ก้างปลาเครือ": 90,
    "กาซะลองคำ ปีบทอง": 90,
    "กาบหอยแครง ว่านกาบหอย": 90,
    "การะเกด": 90,
    "กาสามปีก": 90,
    "กาหลง": 90,
    "กำจัดดอย หมักก้ากดอยสุเทพ": 90,
    "กำลังควายถึก": 90,
    "กินกุ้งน้อย": 90,
    "กุ่มน้ำ": 90,
    "กุ่มบก": 90,
    "กุยช่าย": 60,
    "กุหลาบมอญ ยี่สุ่น": 90,
    "เกล็ดปลาช่อน": 90,
    "เกล็ดหอย หญ้าเกล็ดหอย": 90,
    "แก่นตะวัน": 90,
    "โกฐเชียง ตังกุย": 90,
    "โกฐน้ำเต้า ตั่วอึ๊ง": 90,
    "โกฐพุงปลา จุกโรหินี": 90,
    "ไกร เลียบ": 90,
    "ข ขจร สลิด": 90,
    "ขมิ้นชัน ขมิ้นแกง": 90,
    "ขมิ้นดำ ว่านมหาเมฆ": 90,
    "ขมิ้นอ้อย ว่านเหลือง": 90,
    "ขยัน ย่านางแดง": 90,
    "ขลู่": 90,
    "ขวง สะเดาดิน": 90,
    "ข่า": 90,
    "ขางครั่ง ดอกครั่ง": 90,
    "ข่าตาแดง": 90,
    "ข้าว": 180,
    "ข้าวโพด": 120,
    "ข้าวเม่านก": 120,
    "ข้าวเย็นเหนือ": 180,
    "ข้าวสารดอกเล็ก": 120,
    "ข้าวสารดอกใหญ่": 120,
    "ข้าวสาลี": 120,
    "ข้าวโอ๊ต": 120,
    "ขิง": 90,
    "ขี้หนอน": 90,
    "ขี้เหล็ก": 90,
    "ขี้เหล็กเทศ ชุมเห็ดเล็ก": 90,
    "ขี้เหล็กเลือด": 90,
    "ขี้เหล็กอเมริกัน สุวรรณพฤกษ์": 90,
    "ขึ้นฉ่าย": 90,
    "แข้งกวางดง": 90,
    "ค คดสัง": 90,
    "คว่ำตายหงายเป็น": 90,
    "ควินิน": 90,
    "ค้อนหมาขาว": 90,
    "คะน้า": 60,
    "คัดเค้า คัดเค้าเครือ": 90,
    "คันทรง ผักก้านตรง": 90,
    "เครือขยัน ย่านางแดง": 90,
    "เครือหมาน้อย กรุงเขมา": 90,
    "แค": 90,
    "แคทะเล แคน้ำ": 90,
    "แคนา แคขาว": 90,
    "แครอท": 90,
    "แคแสด แคแดง": 90,
    "แคหัวหมู": 90,
    "แคหางค่าง แคบิด": 90,
    "โคลงเคลง โคลงเคลงขี้นก": 90,
    "ไคร้นุ่น สนุ่น": 90,
    "ง งาขี้ม้อน งาม้อน": 90,
    "งิ้ว งิ้วบ้าน งิ้วแดง": 90,
    "งิ้วป่า งิ้วป่าดอกขาว": 90,
    "เงาะถอดรูป ผักโขมสวน": 90,
    "จ จมูกปลาหลด": 90,
    "จอก": 90,
    "จักรนารายณ์ แปะตำปึง": 90,
    "จัน อินจัน จันทน์ลูกหอม": 90,
    "จาก": 90,
    "จ้ำเครือ ตาเป็ดตาไก่": 90,
    "จำปาดะ": 90,
    "จิกน้ำ จิกนา": 90,
    "จิกสวน จิกบ้าน": 90,
    "จุกโรหินี บวบลม": 90,
    "แจง": 90,
    "ชะพลู": 90,
    "ชะพลูป่า": 90,
    "ชะมดต้น": 90,
    "ชะมวง ส้มโมง": 90,
    "ชะอม": 90,
    "ชา": 90,
    "ชายผ้าสีดา": 90,
    "ชำมะเลียง": 90,
    "ชิด ตาว ต๋าว": 90,
    "ชุมเห็ดจีน": 90,
    "ชุมเห็ดเทศ": 90,
    "ชุมเห็ดไทย": 90,
    "ชุมเห็ดเล็ก ขี้เหล็กเทศ": 90,
    "ดอกครั่ง ขางครั่ง": 90,
    "ดอกดินแดง ดอกดิน": 90,
    "ดาวเรือง": 90,
    "ดาวเรืองฝรั่ง": 90,
    "ดีปลี": 90,
    "ดีหมี": 90,
    "เดื่อผา เดื่อน้ำ": 90,
    "เดื่อหว้า มะเดื่อหว้า": 90,
    "ตดหมูตดหมา": 90,
    "ตะคร้อ": 90,
    "ตะค้านเล็ก": 90,
    "ตะไคร้": 90,
    "ตะลิงปลิง": 90,
    "ตังกุย โกฐเชียง": 90,
    "ตับเต่านา ผักตับเต่า": 90,
    "ตั่วอึ๊ง โกฐน้ำเต้า": 90,
    "ตานหม่อน": 90,
    "ตาเป็ดตาไก่ จ้ำเครือ": 90,
    "ตาล": 90,
    "ตาว ต๋าว ชิด": 90,
    "ตำแยแมว": 90,
    "ตำลึง": 70,
    "ติ้วเกลี้ยง": 90,
    "ติ้วขาว": 90,
    "ตุ้มเต๋น ลำพูป่า": 90,
    "เต่าร้างแดง เต่าร้าง": 90,
    "เติม ประดู่ส้ม": 90,
    "แตงกวา": 70,
    "ถ่อน ทิ้งถ่อน": 90,
    "ถอบแถบเครือ": 90,
    "ถั่วเขียว": 90,
    "ถั่วงอก": 90,
    "ถั่วแปบ": 90,
    "ถั่วฝักยาว": 90,
    "ถั่วพู": 90,
    "ถั่วแระ ถั่วแระต้น": 90,
    "ถั่วลันเตา": 90,
    "เถาขยัน ย่านางแดง": 90,
    "เถาคัน เถาคันแดง": 90,
    "เถาวัลย์ปูน": 90,
    "เถาวัลย์เปรียง": 90,
    "ทรงบาดาล": 90,
    "ทองหลางใบมน": 90,
    "ทองหลางป่า": 90,
    "ทานตะวัน": 90,
    "ทิ้งถ่อน ถ่อน": 90,
    "ทุเรียนเทศ ทุเรียนน้ำ": 90,
    "เท้ายายม่อม": 90,
    "เทียนบ้าน เทียนดอก": 90,
    "เทียนสัตตบุษย์": 90,
    "ธูปฤาษี กกช้าง": 70,
    "นนทรี": 90,
    "นมสวรรค์ พนมสวรรค์": 90,
    "นางจุ่ม นางโจม": 90,
    "นางแย้มป่า": 90,
    "น้ำใจใคร่": 90,
    "น้ำเต้า": 90,
    "น้ำนมราชสีห์ น้ำนมราชสีห์ใหญ่": 90,
    "นุ่น": 90,
    "เนระพูสีไทย ว่านค้างคาวดำ": 90,
    "เนียมหูเสือ หูเสือ": 90,
    "บร็อคโคลี่": 90,
    "บวบขม": 90,
    "บวบลม จุกโรหินี": 90,
    "บวบหอม บวบกลม": 90,
    "บวบเหลี่ยม": 90,
    "บอน": 90,
    "บอนแบ้ว": 90,
    "บอนส้ม": 90,
    "บัวบก": 90,
    "บัวเผื่อน บัวผัน": 90,
    "บัวสาย บัวขม": 90,
    "บัวหลวง": 90,
    "บานไม่รู้โรย บานไม่รู้โรยดอกขาว": 90,
    "บีทรูท": 90,
    "บุก": 90,
    "บุกคางคก": 90,
    "บุกอีรอกเขา อีรอก": 90,
    "บุนนาค": 90,
    "ประคำดีควาย มะคำดีควาย": 90,
    "ประดู่ ประดู่บ้าน": 90,
    "ประดู่ส้ม เติม": 90,
    "ปอกระเจา": 90,
    "ปอทะเล": 90,
    "ปีบทอง กาซะลองคำ": 90,
    "ปืนนกไส้": 90,
    "ปุดใหญ่ ปุด": 90,
    "เปราะป่า": 90,
    "เปราะหอม": 90,
    "เปล้าน้อย เปล้าท่าโพ": 90,
    "แปะตำปึง จักรนารายณ์": 90,
    "ผักกระเฉด": 90,
    "ผักกระชับ หญ้าผมยุ่ง": 60,
    "ผักกวางตุ้ง": 90,
    "ผักกะโฉม": 90,
    "ผักกะเดียง": 90,
    "ผักกาดขาว": 90,
    "ผักกาดนอ ผักกาดน้ำดอกเหลือง": 90,
    "ผักกาดน้ำ หญ้าเอ็นยืด": 90,
    "ผักกาดส้ม": 90,
    "ผักกาดหอม ผักสลัด": 90,
    "ผักกาดหัว หัวไชเท้า": 90,
    "ผักก้านตรง คันทรง": 90,
    "ผักกูด": 90,
    "ผักขมใบแดง": 90,
    "ผักขมหิน ผักโขมหิน": 90,
    "ผักขวง สะเดาดิน": 90,
    "ผักขี้หูด": 90,
    "ผักแขยง": 90,
    "ผักโขม": 90,
    "ผักโขม ผักโขมหัด": 90,
    "ผักโขมสวน ผักขมสวน": 90,
    "ผักโขมหนาม ผักขมหนาม": 90,
    "ผักคราดหัวแหวน": 90,
    "ผักคะน้า": 60,
    "ผักคาวตอง พลูคาว": 90,
    "ผักเค็ด ผักหวานบ้าน": 90,
    "ผักแครด": 90,
    "ผักงวม หนามโค้ง": 90,
    "ผักชี": 60,
    "ผักชีฝรั่ง": 90,
    "ผักชีล้อม": 90,
    "ผักชีลาว": 90,
    "ผักเชียงดา ผักจินดา": 90,
    "ผักตบชวา": 90,
    "ผักตบไทย": 90,
    "ผักตับเต่า ตับเต่านา": 90,
    "ผักติ้ว": 90,
    "ผักบุ้ง": 60,
    "ผักบุ้งร่วม": 60,
    "ผักบุ้งรั้ว": 60,
    "ผักเบี้ยหิน": 90,
    "ผักเบี้ยใหญ่": 90,
    "ผักปลัง": 90,
    "ผักปลาบ ผักปลาบใบกว้าง": 90,
    "ผักปลาบใบแคบ": 90,
    "ผักเป็ด ผักเป็ดขาว": 90,
    "ผักเป็ดแดง": 90,
    "ผักเป็ดน้ำ ผักเป็ด": 90,
    "ผักแพว ผักไผ่": 90,
    "ผักวอเตอร์เครส": 90,
    "ผักแว่น ผักลิ้นปี่": 90,
    "ผักแว่นแก้ว แว่นแก้ว": 90,
    "ผักเสี้ยน": 90,
    "ผักเสี้ยนผี": 90,
    "ผักหนาม": 90,
    "ผักหวาน ผักหวานบ้าน": 90,
    "ผักหวานป่า": 90,
    "ผักฮ้วนหมู กระทุงหมาบ้า": 90,
    "เผือก": 90,
    "โผงเผง": 90,
    "ฝ ฝอยทอง": 90,
    "ฝิ่นต้น": 90,
    "พ พญาดง": 90,
    "พนมสวรรค์ นมสวรรค์": 90,
    "พริก": 90,
    "พริกขี้หนู": 90,
    "พริกชี้ฟ้า": 90,
    "พริกไทย": 90,
    "พริกหยวก": 90,
    "พริกหวาน": 90,
    "พลองแก้มอ้น": 90,
    "พลองเหมือด พลองดำ": 90,
    "พลูคาว ผักคาวตอง": 90,
    "พวงไข่มุก": 90,
    "พวงชมพู": 90,
    "พะยอม พยอม": 90,
    "พาร์สลี่ย์": 90,
    "พิลังกาสา": 90,
    "พุทธรักษา": 90,
    "พุทธรักษากินหัว": 90,
    "เพกา": 90,
    "เพี้ยกระทิง": 90,
    "แพงพวยน้ำ": 90,
    "โพทะเล โพธิ์ทะเล": 90,
    "โพธิ์": 90,
    "ฟักข้าว": 120,
    "ฟักเขียว": 100,
    "ฟักทอง": 100,
    "ฟักแม้ว มะระหวาน": 100,
    "เฟื่องฟ้า": 90,
    "มหาหงส์ ว่านมหาหงส์": 90,
    "มะกรูด": 150,
    "มะกล่ำต้น มะกล่ำตาช้าง": 90,
    "มะกอกฝรั่ง": 90,
    "มะเขือขื่น": 90,
    "มะเขือเทศ": 110,
    "มะเขือเปราะ": 90,
    "มะเขือพวง": 90,
    "มะเขือม่วง": 90,
    "มะเขือยาว": 90,
    "มะคำดีควาย ประคำดีควาย": 90,
    "มะดัน": 90,
    "มะเดื่อชุมพร มะเดื่ออุทุมพร": 90,
    "มะเดื่อปล้อง": 90,
    "มะเดื่อหว้า เดื่อหว้า": 90,
    "มะตูม": 90,
    "มะนาว": 120,
    "มะพร้าว": 360,
    "มะเฟือง": 90,
    "มะไฟ": 90,
    "มะเม่า มะเม่าหลวง หมากเม่า": 90,
    "มะระ มะระจีน": 90,
    "มะระขี้นก": 100,
    "มะรุม": 120,
    "มะละกอ": 150,
    "มะแว้งเครือ": 90,
    "มะแว้งต้น มะแว้ง": 90,
    "มะแว้งนก หญ้าต้อมต๊อก": 90,
    "มะสัง": 90,
    "มะหวด": 90,
    "มะหาด": 90,
    "มะเหลี่ยมหิน ส้มผด": 90,
    "มะอึก": 90,
    "มันแกว": 90,
    "มันเทศ": 120,
    "มัลเบอร์รี่ หม่อน": 90,
    "เม่าไข่ปลา": 90,
    "เม่าสร้อย": 90,
    "เมื่อย มะเมื่อย": 90,
    "แมงลัก": 60,
    "โมกแดง": 90,
    "โมกมัน": 90,
    "ไม้เท้ายายม่อม": 90,
    "ย ยอ": 90,
    "ยอเถื่อน ยอป่า": 90,
    "ยอป่า": 90,
    "ยางเหียง เหียง": 90,
    "ย่านพาโหม": 90,
    "ย่านลิเภา หญ้ายายเภา": 90,
    "ย่านางแดง ขยัน": 90,
    "ยี่สุ่น กุหลาบมอญ": 90,
    "ยี่หร่า กะเพราควาย": 60,
    "ระย่อม ระย่อมน้อย": 90,
    "รากสามสิบ สาวร้อยผัว": 90,
    "รางจืด": 90,
    "รามใหญ่": 90,
    "เร่ว เร่วใหญ่": 90,
    "เร่วหอม": 90,
    "ลำพูป่า ตุ้มเต๋น": 90,
    "ลิ้นกวาง": 90,
    "ลิเภา ย่านลิเภา": 90,
    "เล็บมือนาง": 90,
    "เล็บเหยี่ยว": 90,
    "เลี่ยน": 90,
    "เลียบ ไกร": 90,
    "ว่านกาบหอย กาบหอยแครง": 90,
    "ว่านกีบแรด": 90,
    "ว่านค้างคาวดำ เนระพูสีไทย": 90,
    "ว่านท้องใบม่วง": 90,
    "ว่านน้ำ": 90,
    "ว่านพระฉิม": 90,
    "ว่านมหากาฬ": 90,
    "ว่านมหาเมฆ ขมิ้นดำ": 90,
    "ว่านมหาหงส์ มหาหงส์": 90,
    "ว่านเหลือง ขมิ้นอ้อย": 90,
    "แว่นแก้ว ผักแว่นแก้ว": 90,
    "สนุ่น ไคร้นุ่น": 90,
    "สบู่ดำ": 90,
    "ส้มกบ": 90,
    "ส้มกุ้ง สนขี้มด": 90,
    "ส้มแขก": 90,
    "ส้มเช้า": 90,
    "ส้มป่อย": 90,
    "ส้มผด มะเหลี่ยมหิน": 90,
    "ส้มโมง ชะมวง": 90,
    "ส้มลม": 90,
    "สมัดน้อย ฮัสคุณ": 90,
    "สมัดใหญ่ สันโสก หวดหม่อน": 90,
    "สร้อยทับทิม": 90,
    "สลิด ขจร": 90,
    "สะเดา สะเดาไทย": 90,
    "สะเดาดิน ผักขวง": 90,
    "สะตอ": 100,
    "สะระแหน่": 60,
    "สะอึก": 90,
    "สันพร้าหอม": 90,
    "สาวร้อยผัว รากสามสิบ": 90,
    "สุวรรณพฤกษ์ ขี้เหล็กอเมริกัน": 90,
    "เสม็ด เสม็ดขาว": 90,
    "เสลดพังพอนตัวเมีย": 90,
    "เสี้ยวดอกขาว": 90,
    "แสมสาร": 90,
    "โสกน้ำอโศกน้ำ": 90,
    "โสน โสนกินดอก": 90,
    "โสมซานชี": 90,
    "โสมไทย โสมคน": 90,
    "ห หญ้าเกล็ดหอย เกล็ดหอย": 90,
    "หญ้าไข่เหา": 90,
    "หญ้าต้อมต๊อก มะแว้งนก": 90,
    "หญ้าปักกิ่ง หญ้าเทวดา": 90,
    "หญ้าผมยุ่ง ผักกระชับ": 60,
    "หญ้าฝรั่น": 90,
    "หญ้ายายเภา ย่านลิเภา": 90,
    "หญ้าหนวดแมว": 90,
    "หญ้าเอ็นยืด ผักกาดน้ำ": 90,
    "หนาดคำ": 90,
    "หนามโค้ง ผักงวม": 90,
    "หนามแน่แดง": 90,
    "หม่อน มัลเบอร์รี่": 90,
    "หมักก้ากดอยสุเทพ กำจัดดอย": 90,
    "หมากผู้หมากเมีย": 90,
    "หวดหม่อน สันโสก สมัดใหญ่": 90,
    "หว้า": 90,
    "หอมไก๋ กระดูกไก่ หอมแดง": 90,
    "หอมใหญ่ หอมหัวใหญ่": 90,
    "หัวไชเท้า ผักกาดหัว": 90,
    "หัสคุณ สมัดน้อย": 90,
    "หางนกยูงฝรั่ง": 90,
    "หูปลาช่อน": 90,
    "หูเสือ เนียมหูเสือ": 90,
    "เห็ดเป๋าฮื้อ": 90,
    "เห็ดหูหนู": 90,
    "เหรียง": 90,
    "เหียง ยางเหียง": 90,
    "แห้วหมู": 90,
    "หญ้าแห้วหมูโหระพา": 90,
    "โหระพาช้าง": 60,
    "ยี่หร่า": 60,
    "อ อบเชยเถา": 90,
    "อวดเชือก": 90,
    "อโศกน้ำ โสกน้ำ": 90,
    "อ้อย": 150,
    "อ้อยช้าง กอกกั๋น": 150,
    "อัคคีทวาร": 90,
    "อัญชัน": 90,
    "อัลฟาฟ่า": 90,
    "อินจัน": 90,
    "อีรอก": 90,
    "อุตพิต": 90,
    "อุโลก": 90,
    "เอื้องหมายนา": 90,
    "กัญชง": 120,
}

@app.route('/api/sensor/latest', methods=['GET'])
def get_latest_sensor():
    data = [{
        "temperature": round(random.uniform(25, 30), 1),
        "moisture": random.randint(40, 80),
        "timestamp": datetime.now().strftime('%Y-%m-%d %H:%M:%S')
    }]
    return jsonify(data)

@app.route('/api/predict_growth', methods=['POST'])
def predict_growth():
    data = request.json

    try:
        plant_date_str = data.get('plantDate')
        plant_type = data.get('plantType')
        plant_height = float(data.get('plantHeight', 0))
        temperature = float(data.get('temperature', 0))
        moisture = float(data.get('moisture', 0))
        current_date = datetime.now()

        plant_date = datetime.strptime(plant_date_str, '%Y-%m-%d')
        days_since_plant = (current_date - plant_date).days
        if days_since_plant < 0:
            days_since_plant = 0

        growth_rate = 0.5 + (temperature - 25) * 0.05 + (moisture - 50) * 0.02
        predicted_growth = plant_height + growth_rate * days_since_plant

        harvest_days = HARVEST_DAYS.get(plant_type, 30)
        harvest_date = plant_date + timedelta(days=harvest_days)
        harvest_date_str = harvest_date.strftime('%Y-%m-%d')

        if days_since_plant >= harvest_days:
            harvest_status = "พร้อมเก็บผลผลิตได้แล้ว"
            days_to_harvest = 0
        else:
            harvest_status = f"คาดว่าจะเก็บได้ในอีก {harvest_days - days_since_plant} วัน"
            days_to_harvest = harvest_days - days_since_plant

        return jsonify({
            'predicted_height_cm': round(predicted_growth, 2),
            'days_since_plant': days_since_plant,
            'growth_rate_cm_per_day': round(growth_rate, 2),
            'plant_type': plant_type,
            'harvest_days': harvest_days,
            'estimated_harvest_date': harvest_date_str,
            'harvest_status': harvest_status,
            'days_to_harvest': days_to_harvest
        })

    except Exception as e:
        return jsonify({'error': str(e)}), 400

if __name__ == '__main__':
    app.run(host='0.0.0.0', port=8000)
